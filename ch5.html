<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>第 5 章: 代码组合（compose） | JavaScript 函数式编程指南中文版</title>
    
    <meta name="description" content="">
    
    <link rel="preload" href="/mostly-adequate-guide-chinese/assets/css/0.styles.e373d42e.css" as="style"><link rel="preload" href="/mostly-adequate-guide-chinese/assets/js/app.e22f068f.js" as="script"><link rel="preload" href="/mostly-adequate-guide-chinese/assets/js/2.35b03a7f.js" as="script"><link rel="preload" href="/mostly-adequate-guide-chinese/assets/js/6.5b22d12f.js" as="script"><link rel="prefetch" href="/mostly-adequate-guide-chinese/assets/js/10.9ff47bf3.js"><link rel="prefetch" href="/mostly-adequate-guide-chinese/assets/js/11.1613d626.js"><link rel="prefetch" href="/mostly-adequate-guide-chinese/assets/js/12.5037078b.js"><link rel="prefetch" href="/mostly-adequate-guide-chinese/assets/js/13.54fbdcfe.js"><link rel="prefetch" href="/mostly-adequate-guide-chinese/assets/js/14.85525b84.js"><link rel="prefetch" href="/mostly-adequate-guide-chinese/assets/js/15.b0675b5a.js"><link rel="prefetch" href="/mostly-adequate-guide-chinese/assets/js/16.44cb92b7.js"><link rel="prefetch" href="/mostly-adequate-guide-chinese/assets/js/17.15cbb2bc.js"><link rel="prefetch" href="/mostly-adequate-guide-chinese/assets/js/18.9af46e61.js"><link rel="prefetch" href="/mostly-adequate-guide-chinese/assets/js/19.8afc0231.js"><link rel="prefetch" href="/mostly-adequate-guide-chinese/assets/js/3.c39a0118.js"><link rel="prefetch" href="/mostly-adequate-guide-chinese/assets/js/4.47caff48.js"><link rel="prefetch" href="/mostly-adequate-guide-chinese/assets/js/5.209b7f11.js"><link rel="prefetch" href="/mostly-adequate-guide-chinese/assets/js/7.9f81ff05.js"><link rel="prefetch" href="/mostly-adequate-guide-chinese/assets/js/8.95229e13.js"><link rel="prefetch" href="/mostly-adequate-guide-chinese/assets/js/9.2faab3a0.js">
    <link rel="stylesheet" href="/mostly-adequate-guide-chinese/assets/css/0.styles.e373d42e.css">
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-JNFKK7VGLS"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-JNFKK7VGLS');
    </script>
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/mostly-adequate-guide-chinese/" class="home-link router-link-active"><!----> <span class="site-name">JavaScript 函数式编程指南中文版</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/mostly-adequate-guide-chinese/ch1.html" class="sidebar-link">第 1 章：我们在做什么？</a></li><li><a href="/mostly-adequate-guide-chinese/ch2.html" class="sidebar-link">第 2 章: 一等公民的函数</a></li><li><a href="/mostly-adequate-guide-chinese/ch3.html" class="sidebar-link">第 3 章：纯函数的好处</a></li><li><a href="/mostly-adequate-guide-chinese/ch4.html" class="sidebar-link">第 4 章: 柯里化（curry）</a></li><li><a href="/mostly-adequate-guide-chinese/ch5.html" aria-current="page" class="active sidebar-link">第 5 章: 代码组合（compose）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mostly-adequate-guide-chinese/ch5.html#函数饲养" class="sidebar-link">函数饲养</a></li><li class="sidebar-sub-header"><a href="/mostly-adequate-guide-chinese/ch5.html#pointfree" class="sidebar-link">pointfree</a></li><li class="sidebar-sub-header"><a href="/mostly-adequate-guide-chinese/ch5.html#debug" class="sidebar-link">debug</a></li><li class="sidebar-sub-header"><a href="/mostly-adequate-guide-chinese/ch5.html#范畴学" class="sidebar-link">范畴学</a></li><li class="sidebar-sub-header"><a href="/mostly-adequate-guide-chinese/ch5.html#总结" class="sidebar-link">总结</a></li><li class="sidebar-sub-header"><a href="/mostly-adequate-guide-chinese/ch5.html#练习" class="sidebar-link">练习</a></li></ul></li><li><a href="/mostly-adequate-guide-chinese/ch6.html" class="sidebar-link">第 6 章: 示例应用</a></li><li><a href="/mostly-adequate-guide-chinese/ch7.html" class="sidebar-link">第 7 章: Hindley-Milner 类型签名</a></li><li><a href="/mostly-adequate-guide-chinese/ch8.html" class="sidebar-link">第 8 章: 特百惠</a></li><li><a href="/mostly-adequate-guide-chinese/ch9.html" class="sidebar-link">第 9 章: Monad</a></li><li><a href="/mostly-adequate-guide-chinese/ch10.html" class="sidebar-link">第 10 章：Applicative Functor</a></li><li><a href="/mostly-adequate-guide-chinese/ch11.html" class="sidebar-link">第 11 章：再转换一次，就很自然</a></li><li><a href="/mostly-adequate-guide-chinese/ch12.html" class="sidebar-link">第 12 章：遍历</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="第-5-章-代码组合-compose"><a href="#第-5-章-代码组合-compose" class="header-anchor">#</a> 第 5 章: 代码组合（compose）</h1> <h2 id="函数饲养"><a href="#函数饲养" class="header-anchor">#</a> 函数饲养</h2> <p>这就是 <code>组合</code>（compose，以下将称之为组合）：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> <span class="token function-variable function">compose</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">f<span class="token punctuation">,</span>g</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token function">g</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p><code>f</code> 和 <code>g</code> 都是函数，<code>x</code> 是在它们之间通过“管道”传输的值。</p> <p><code>组合</code>看起来像是在饲养函数。你就是饲养员，选择两个有特点又遭你喜欢的函数，让它们结合，产下一个崭新的函数。组合的用法如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> <span class="token function-variable function">toUpperCase</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> x<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> <span class="token function-variable function">exclaim</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> x <span class="token operator">+</span> <span class="token string">'!'</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> shout <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span>exclaim<span class="token punctuation">,</span> toUpperCase<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">shout</span><span class="token punctuation">(</span><span class="token string">&quot;send in the clowns&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//=&gt; &quot;SEND IN THE CLOWNS!&quot;</span>
</code></pre></div><p>两个函数组合之后返回了一个新函数是完全讲得通的：组合某种类型（本例中是函数）的两个元素本就该生成一个该类型的新元素。把两个乐高积木组合起来绝不可能得到一个林肯积木。所以这是有道理的，我们将在适当的时候探讨这方面的一些底层理论。</p> <p>在 <code>compose</code> 的定义中，<code>g</code> 将先于 <code>f</code> 执行，因此就创建了一个从右到左的数据流。这样做的可读性远远高于嵌套一大堆的函数调用，如果不用组合，<code>shout</code> 函数将会是这样的：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> <span class="token function-variable function">shout</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">exclaim</span><span class="token punctuation">(</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>让代码从右向左运行，而不是由内而外运行，我觉得可以称之为“左倾”（吁——）。我们来看一个顺序很重要的例子：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> <span class="token function-variable function">head</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> reverse <span class="token operator">=</span> <span class="token function">reduce</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">acc<span class="token punctuation">,</span> x</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>acc<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> last <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span>head<span class="token punctuation">,</span> reverse<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">last</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'jumpkick'</span><span class="token punctuation">,</span> <span class="token string">'roundhouse'</span><span class="token punctuation">,</span> <span class="token string">'uppercut'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//=&gt; 'uppercut'</span>
</code></pre></div><p><code>reverse</code> 反转列表，<code>head</code> 取列表中的第一个元素；所以结果就是得到了一个 <code>last</code> 函数（译者注：即取列表的最后一个元素），虽然它性能不高。这个组合中函数的执行顺序应该是显而易见的。尽管我们可以定义一个从左向右的版本，但是从右向左执行更加能够反映数学上的含义——是的，组合的概念直接来自于数学课本。实际上，现在是时候去看看所有的组合都有的一个特性了。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 结合律（associativity）</span>
<span class="token keyword">var</span> associative <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token function">compose</span><span class="token punctuation">(</span>g<span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token function">compose</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> g<span class="token punctuation">)</span><span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// true</span>
</code></pre></div><p>这个特性就是结合律，符合结合律意味着不管你是把 <code>g</code> 和 <code>h</code> 分到一组，还是把 <code>f</code> 和 <code>g</code> 分到一组都不重要。所以，如果我们想把字符串变为大写，可以这么写：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">compose</span><span class="token punctuation">(</span>toUpperCase<span class="token punctuation">,</span> <span class="token function">compose</span><span class="token punctuation">(</span>head<span class="token punctuation">,</span> reverse<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 或者</span>
<span class="token function">compose</span><span class="token punctuation">(</span><span class="token function">compose</span><span class="token punctuation">(</span>toUpperCase<span class="token punctuation">,</span> head<span class="token punctuation">)</span><span class="token punctuation">,</span> reverse<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>因为如何为 <code>compose</code> 的调用分组不重要，所以结果都是一样的。这也让我们有能力写一个可变的组合（variadic compose），用法如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 前面的例子中我们必须要写两个组合才行，但既然组合是符合结合律的，我们就可以只写一个，</span>
<span class="token comment">// 而且想传给它多少个函数就传给它多少个，然后让它自己决定如何分组。</span>

<span class="token keyword">var</span> lastUpper <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span>toUpperCase<span class="token punctuation">,</span> head<span class="token punctuation">,</span> reverse<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">lastUpper</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'jumpkick'</span><span class="token punctuation">,</span> <span class="token string">'roundhouse'</span><span class="token punctuation">,</span> <span class="token string">'uppercut'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//=&gt; 'UPPERCUT'</span>


<span class="token keyword">var</span> loudLastUpper <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span>exclaim<span class="token punctuation">,</span> toUpperCase<span class="token punctuation">,</span> head<span class="token punctuation">,</span> reverse<span class="token punctuation">)</span>

<span class="token function">loudLastUpper</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'jumpkick'</span><span class="token punctuation">,</span> <span class="token string">'roundhouse'</span><span class="token punctuation">,</span> <span class="token string">'uppercut'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//=&gt; 'UPPERCUT!'</span>
</code></pre></div><p>运用结合律能为我们带来强大的灵活性，还有对执行结果不会出现意外的那种平和心态。至于稍微复杂些的可变组合，也都包含在本书的 <code>support</code> 库里了，而且你也可以在类似 <a href="https://lodash.com/" target="_blank" rel="noopener noreferrer">lodash<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="http://underscorejs.org/" target="_blank" rel="noopener noreferrer">underscore<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 以及 <a href="http://ramdajs.com/" target="_blank" rel="noopener noreferrer">ramda<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 这样的类库中找到它们的常规定义。</p> <p>结合律的一大好处是任何一个函数分组都可以被拆开来，然后再以它们自己的组合方式打包在一起。让我们来重构重构前面的例子：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> loudLastUpper <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span>exclaim<span class="token punctuation">,</span> toUpperCase<span class="token punctuation">,</span> head<span class="token punctuation">,</span> reverse<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 或</span>
<span class="token keyword">var</span> last <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span>head<span class="token punctuation">,</span> reverse<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> loudLastUpper <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span>exclaim<span class="token punctuation">,</span> toUpperCase<span class="token punctuation">,</span> last<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 或</span>
<span class="token keyword">var</span> last <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span>head<span class="token punctuation">,</span> reverse<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> angry <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span>exclaim<span class="token punctuation">,</span> toUpperCase<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> loudLastUpper <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span>angry<span class="token punctuation">,</span> last<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 更多变种...</span>
</code></pre></div><p>关于如何组合，并没有标准的答案——我们只是以自己喜欢的方式搭乐高积木罢了。通常来说，最佳实践是让组合可重用，就像 <code>last</code> 和 <code>angry</code> 那样。如果熟悉 Fowler 的《<a href="http://martinfowler.com/books/refactoring.html" target="_blank" rel="noopener noreferrer">重构<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>》一书的话，你可能会认识到这个过程叫做 “<a href="http://refactoring.com/catalog/extractMethod.html" target="_blank" rel="noopener noreferrer">extract method<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>”——只不过不需要关心对象的状态。</p> <h2 id="pointfree"><a href="#pointfree" class="header-anchor">#</a> pointfree</h2> <p>pointfree 模式指的是，永远不必说出你的数据。咳咳对不起（译者注：此处原文是“Pointfree style means never having to say your data”，源自 1970 年的电影 <em>Love Story</em> 里的一句著名台词“Love means never having to say you're sorry”。紧接着作者又说了一句“Excuse me”，大概是一种幽默）。它的意思是说，函数无须提及将要操作的数据是什么样的。一等公民的函数、柯里化（curry）以及组合协作起来非常有助于实现这种模式。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 非 pointfree，因为提到了数据：word</span>
<span class="token keyword">var</span> <span class="token function-variable function">snakeCase</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">word</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> word<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\s+</span><span class="token regex-delimiter">/</span><span class="token regex-flags">ig</span></span><span class="token punctuation">,</span> <span class="token string">'_'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// pointfree</span>
<span class="token keyword">var</span> snakeCase <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\s+</span><span class="token regex-delimiter">/</span><span class="token regex-flags">ig</span></span><span class="token punctuation">,</span> <span class="token string">'_'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> toLowerCase<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>看到 <code>replace</code> 是如何被局部调用的了么？这里所做的事情就是通过管道把数据在接受单个参数的函数间传递。利用 curry，我们能够做到让每个函数都先接收数据，然后操作数据，最后再把数据传递到下一个函数那里去。另外注意在 pointfree 版本中，不需要 <code>word</code> 参数就能构造函数；而在非 pointfree 的版本中，必须要有 <code>word</code> 才能进行一切操作。</p> <p>我们再来看一个例子。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 非 pointfree，因为提到了数据：name</span>
<span class="token keyword">var</span> <span class="token function-variable function">initials</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> name<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token function">compose</span><span class="token punctuation">(</span>toUpperCase<span class="token punctuation">,</span> head<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'. '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// pointfree</span>
<span class="token keyword">var</span> initials <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'. '</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token function">compose</span><span class="token punctuation">(</span>toUpperCase<span class="token punctuation">,</span> head<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">split</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">initials</span><span class="token punctuation">(</span><span class="token string">&quot;hunter stockton thompson&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 'H. S. T'</span>
</code></pre></div><p>另外，pointfree 模式能够帮助我们减少不必要的命名，让代码保持简洁和通用。对函数式代码来说，pointfree 是非常好的石蕊试验，因为它能告诉我们一个函数是否是接受输入返回输出的小函数。比如，while 循环是不能组合的。不过你也要警惕，pointfree 就像是一把双刃剑，有时候也能混淆视听。并非所有的函数式代码都是 pointfree 的，不过这没关系。可以使用它的时候就使用，不能使用的时候就用普通函数。</p> <h2 id="debug"><a href="#debug" class="header-anchor">#</a> debug</h2> <p>组合的一个常见错误是，在没有局部调用之前，就组合类似 <code>map</code> 这样接受两个参数的函数。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 错误做法：我们传给了 `angry` 一个数组，根本不知道最后传给 `map` 的是什么东西。</span>
<span class="token keyword">var</span> latin <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span>map<span class="token punctuation">,</span> angry<span class="token punctuation">,</span> reverse<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">latin</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;frog&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;eyes&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// error</span>


<span class="token comment">// 正确做法：每个函数都接受一个实际参数。</span>
<span class="token keyword">var</span> latin <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token function">map</span><span class="token punctuation">(</span>angry<span class="token punctuation">)</span><span class="token punctuation">,</span> reverse<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">latin</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;frog&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;eyes&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// [&quot;EYES!&quot;, &quot;FROG!&quot;])</span>
</code></pre></div><p>如果在 debug 组合的时候遇到了困难，那么可以使用下面这个实用的，但是不纯的 <code>trace</code> 函数来追踪代码的执行情况。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> trace <span class="token operator">=</span> <span class="token function">curry</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">tag<span class="token punctuation">,</span> x</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>tag<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> x<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> dasherize <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> toLower<span class="token punctuation">,</span> <span class="token function">split</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\s{2,}</span><span class="token regex-delimiter">/</span><span class="token regex-flags">ig</span></span><span class="token punctuation">,</span> <span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">dasherize</span><span class="token punctuation">(</span><span class="token string">'The world is a vampire'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// TypeError: Cannot read property 'apply' of undefined</span>
</code></pre></div><p>这里报错了，来 <code>trace</code> 下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> dasherize <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> toLower<span class="token punctuation">,</span> <span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;after split&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">split</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\s{2,}</span><span class="token regex-delimiter">/</span><span class="token regex-flags">ig</span></span><span class="token punctuation">,</span> <span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// after split [ 'The', 'world', 'is', 'a', 'vampire' ]</span>
</code></pre></div><p>啊！<code>toLower</code> 的参数是一个数组，所以需要先用 <code>map</code> 调用一下它。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> dasherize <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">map</span><span class="token punctuation">(</span>toLower<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">split</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\s{2,}</span><span class="token regex-delimiter">/</span><span class="token regex-flags">ig</span></span><span class="token punctuation">,</span> <span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">dasherize</span><span class="token punctuation">(</span><span class="token string">'The world is a vampire'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 'the-world-is-a-vampire'</span>
</code></pre></div><p><code>trace</code> 函数允许我们在某个特定的点观察数据以便 debug。像 haskell 和 purescript 之类的语言出于开发的方便，也都提供了类似的函数。</p> <p>组合将成为我们构造程序的工具，而且幸运的是，它背后是有一个强大的理论做支撑的。让我们来研究研究这个理论。</p> <h2 id="范畴学"><a href="#范畴学" class="header-anchor">#</a> 范畴学</h2> <p>范畴学（category theory）是数学中的一个抽象分支，能够形式化诸如集合论（set theory）、类型论（type theory）、群论（group theory）以及逻辑学（logic）等数学分支中的一些概念。范畴学主要处理对象（object）、态射（morphism）和变化式（transformation），而这些概念跟编程的联系非常紧密。下图是一些相同的概念分别在不同理论下的形式：</p> <img src="/mostly-adequate-guide-chinese/assets/img/cat_theory.c13012cd.png"> <p>抱歉，我没有任何要吓唬你的意思。我并不假设你对这些概念都了如指掌，我只是想让你明白这里面有多少重复的内容，让你知道为何范畴学要统一这些概念。</p> <p>在范畴学中，有一个概念叫做...范畴。有着以下这些组件（component）的搜集（collection）就构成了一个范畴：</p> <ul><li>对象的搜集</li> <li>态射的搜集</li> <li>态射的组合</li> <li>identity 这个独特的态射</li></ul> <p>范畴学抽象到足以模拟任何事物，不过目前我们最关心的还是类型和函数，所以让我们把范畴学运用到它们身上看看。</p> <p><strong>对象的搜集</strong></p> <p>对象就是数据类型，例如 <code>String</code>、<code>Boolean</code>、<code>Number</code> 和 <code>Object</code> 等等。通常我们把数据类型视作所有可能的值的一个集合（set）。像 <code>Boolean</code> 就可以看作是 <code>[true, false]</code> 的集合，<code>Number</code> 可以是所有实数的一个集合。把类型当作集合对待是有好处的，因为我们可以利用集合论（set theory）处理类型。</p> <p><strong>态射的搜集</strong></p> <p>态射是标准的、普通的纯函数。</p> <p><strong>态射的组合</strong></p> <p>你可能猜到了，这就是本章介绍的新玩意儿——<code>组合</code>。我们已经讨论过 <code>compose</code> 函数是符合结合律的，这并非巧合，结合律是在范畴学中对任何组合都适用的一个特性。</p> <p>这张图展示了什么是组合：</p> <img src="/mostly-adequate-guide-chinese/assets/img/cat_comp1.e6d9e9dd.png"> <img src="/mostly-adequate-guide-chinese/assets/img/cat_comp2.65cd8275.png"> <p>这里有一个具体的例子：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> <span class="token function-variable function">g</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">return</span> x<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> <span class="token function-variable function">f</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">return</span> x <span class="token operator">===</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> isFourLetterWord <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> g<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>identity 这个独特的态射</strong></p> <p>让我们介绍一个名为 <code>id</code> 的实用函数。这个函数接受随便什么输入然后原封不动地返回它：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> <span class="token function-variable function">id</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">return</span> x<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>你可能会问“这到底哪里有用了？”。别急，我们会在随后的章节中拓展这个函数的，暂时先把它当作一个可以替代给定值的函数——一个假装自己是普通数据的函数。</p> <p><code>id</code> 函数跟组合一起使用简直完美。下面这个特性对所有的一元函数（unary function）（一元函数：只接受一个参数的函数） <code>f</code> 都成立：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// identity</span>
<span class="token function">compose</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> f<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token function">compose</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> id<span class="token punctuation">)</span> <span class="token operator">==</span> f<span class="token punctuation">;</span>
<span class="token comment">// true</span>
</code></pre></div><p>嘿，这就是实数的单位元（identity property）嘛！如果这还不够清楚直白，别着急，慢慢理解它的无用性。很快我们就会到处使用 <code>id</code> 了，不过暂时我们还是把它当作一个替代给定值的函数。这对写 pointfree 的代码非常有用。</p> <p>好了，以上就是类型和函数的范畴。不过如果你是第一次听说这些概念，我估计你还是有些迷糊，不知道范畴到底是什么，为什么有用。没关系，本书全书都在借助这些知识编写示例代码。至于现在，就在本章，本行文字中，你至少可以认为它向我们提供了有关组合的知识——比如结合律和单位律。</p> <p>除了类型和函数，还有什么范畴呢？还有很多，比如我们可以定义一个有向图（directed graph），以节点为对象，以边为态射，以路径连接为组合。还可以定义一个实数类型（Number），以所有的实数为对象，以 <code>&gt;=</code> 为态射（实际上任何偏序（partial order）或全序（total order）都可以成为一个范畴）。范畴的总数是无限的，但是要达到本书的目的，我们只需要关心上面定义的范畴就好了。至此我们已经大致浏览了一些表面的东西，必须要继续后面的内容了。</p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>组合像一系列管道那样把不同的函数联系在一起，数据就可以也必须在其中流动——毕竟纯函数就是输入对输出，所以打破这个链条就是不尊重输出，就会让我们的应用一无是处。</p> <p>我们认为组合是高于其他所有原则的设计原则，这是因为组合让我们的代码简单而富有可读性。另外范畴学将在应用架构、模拟副作用和保证正确性方面扮演重要角色。</p> <p>现在我们已经有足够的知识去进行一些实际的练习了，让我们来编写一个示例应用。</p> <p><a href="/mostly-adequate-guide-chinese/ch6.html">第 6 章: 示例应用</a></p> <h2 id="练习"><a href="#练习" class="header-anchor">#</a> 练习</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../../support'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> _ <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'ramda'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> accounting <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'accounting'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 示例数据</span>
<span class="token keyword">var</span> <span class="token constant">CARS</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span><span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;Ferrari FF&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">horsepower</span><span class="token operator">:</span> <span class="token number">660</span><span class="token punctuation">,</span> <span class="token literal-property property">dollar_value</span><span class="token operator">:</span> <span class="token number">700000</span><span class="token punctuation">,</span> <span class="token literal-property property">in_stock</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;Spyker C12 Zagato&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">horsepower</span><span class="token operator">:</span> <span class="token number">650</span><span class="token punctuation">,</span> <span class="token literal-property property">dollar_value</span><span class="token operator">:</span> <span class="token number">648000</span><span class="token punctuation">,</span> <span class="token literal-property property">in_stock</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;Jaguar XKR-S&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">horsepower</span><span class="token operator">:</span> <span class="token number">550</span><span class="token punctuation">,</span> <span class="token literal-property property">dollar_value</span><span class="token operator">:</span> <span class="token number">132000</span><span class="token punctuation">,</span> <span class="token literal-property property">in_stock</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;Audi R8&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">horsepower</span><span class="token operator">:</span> <span class="token number">525</span><span class="token punctuation">,</span> <span class="token literal-property property">dollar_value</span><span class="token operator">:</span> <span class="token number">114200</span><span class="token punctuation">,</span> <span class="token literal-property property">in_stock</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;Aston Martin One-77&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">horsepower</span><span class="token operator">:</span> <span class="token number">750</span><span class="token punctuation">,</span> <span class="token literal-property property">dollar_value</span><span class="token operator">:</span> <span class="token number">1850000</span><span class="token punctuation">,</span> <span class="token literal-property property">in_stock</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;Pagani Huayra&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">horsepower</span><span class="token operator">:</span> <span class="token number">700</span><span class="token punctuation">,</span> <span class="token literal-property property">dollar_value</span><span class="token operator">:</span> <span class="token number">1300000</span><span class="token punctuation">,</span> <span class="token literal-property property">in_stock</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// 练习 1:</span>
<span class="token comment">// ============</span>
<span class="token comment">// 使用 _.compose() 重写下面这个函数。提示：_.prop() 是 curry 函数</span>
<span class="token keyword">var</span> <span class="token function-variable function">isLastInStock</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">cars</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> last_car <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">last</span><span class="token punctuation">(</span>cars<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> _<span class="token punctuation">.</span><span class="token function">prop</span><span class="token punctuation">(</span><span class="token string">'in_stock'</span><span class="token punctuation">,</span> last_car<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 练习 2:</span>
<span class="token comment">// ============</span>
<span class="token comment">// 使用 _.compose()、_.prop() 和 _.head() 获取第一个 car 的 name</span>
<span class="token keyword">var</span> nameOfFirstCar <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>


<span class="token comment">// 练习 3:</span>
<span class="token comment">// ============</span>
<span class="token comment">// 使用帮助函数 _average 重构 averageDollarValue 使之成为一个组合</span>
<span class="token keyword">var</span> <span class="token function-variable function">_average</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">xs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">reduce</span><span class="token punctuation">(</span>add<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> xs<span class="token punctuation">)</span> <span class="token operator">/</span> xs<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// &lt;- 无须改动</span>

<span class="token keyword">var</span> <span class="token function-variable function">averageDollarValue</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">cars</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> dollar_values <span class="token operator">=</span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">c</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> c<span class="token punctuation">.</span>dollar_value<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> cars<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">_average</span><span class="token punctuation">(</span>dollar_values<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token comment">// 练习 4:</span>
<span class="token comment">// ============</span>
<span class="token comment">// 使用 compose 写一个 sanitizeNames() 函数，返回一个下划线连接的小写字符串：例如：sanitizeNames([&quot;Hello World&quot;]) //=&gt; [&quot;hello_world&quot;]。</span>

<span class="token keyword">var</span> _underscore <span class="token operator">=</span> <span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\W+</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'_'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//&lt;-- 无须改动，并在 sanitizeNames 中使用它</span>

<span class="token keyword">var</span> sanitizeNames <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>


<span class="token comment">// 彩蛋 1:</span>
<span class="token comment">// ============</span>
<span class="token comment">// 使用 compose 重构 availablePrices</span>

<span class="token keyword">var</span> <span class="token function-variable function">availablePrices</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">cars</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> available_cars <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span><span class="token function">prop</span><span class="token punctuation">(</span><span class="token string">'in_stock'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cars<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> available_cars<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> accounting<span class="token punctuation">.</span><span class="token function">formatMoney</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>dollar_value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">', '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token comment">// 彩蛋 2:</span>
<span class="token comment">// ============</span>
<span class="token comment">// 重构使之成为 pointfree 函数。提示：可以使用 _.flip()</span>

<span class="token keyword">var</span> <span class="token function-variable function">fastestCar</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">cars</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> sorted <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">sortBy</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">car</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">return</span> car<span class="token punctuation">.</span>horsepower <span class="token punctuation">}</span><span class="token punctuation">,</span> cars<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> fastest <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">last</span><span class="token punctuation">(</span>sorted<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> fastest<span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">' is the fastest'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/mostly-adequate-guide-chinese/ch4.html" class="prev">
        第 4 章: 柯里化（curry）
      </a></span> <span class="next"><a href="/mostly-adequate-guide-chinese/ch6.html">
        第 6 章: 示例应用
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/mostly-adequate-guide-chinese/assets/js/app.e22f068f.js" defer></script><script src="/mostly-adequate-guide-chinese/assets/js/2.35b03a7f.js" defer></script><script src="/mostly-adequate-guide-chinese/assets/js/6.5b22d12f.js" defer></script>
  </body>
</html>
