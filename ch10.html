<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>第 10 章：Applicative Functor | JavaScript 函数式编程指南中文版</title>
    
    <meta name="description" content="">
    
    <link rel="preload" href="/mostly-adequate-guide-chinese/assets/css/0.styles.e373d42e.css" as="style"><link rel="preload" href="/mostly-adequate-guide-chinese/assets/js/app.e22f068f.js" as="script"><link rel="preload" href="/mostly-adequate-guide-chinese/assets/js/2.35b03a7f.js" as="script"><link rel="preload" href="/mostly-adequate-guide-chinese/assets/js/10.9ff47bf3.js" as="script"><link rel="prefetch" href="/mostly-adequate-guide-chinese/assets/js/11.1613d626.js"><link rel="prefetch" href="/mostly-adequate-guide-chinese/assets/js/12.5037078b.js"><link rel="prefetch" href="/mostly-adequate-guide-chinese/assets/js/13.54fbdcfe.js"><link rel="prefetch" href="/mostly-adequate-guide-chinese/assets/js/14.85525b84.js"><link rel="prefetch" href="/mostly-adequate-guide-chinese/assets/js/15.b0675b5a.js"><link rel="prefetch" href="/mostly-adequate-guide-chinese/assets/js/16.44cb92b7.js"><link rel="prefetch" href="/mostly-adequate-guide-chinese/assets/js/17.15cbb2bc.js"><link rel="prefetch" href="/mostly-adequate-guide-chinese/assets/js/18.9af46e61.js"><link rel="prefetch" href="/mostly-adequate-guide-chinese/assets/js/19.8afc0231.js"><link rel="prefetch" href="/mostly-adequate-guide-chinese/assets/js/3.c39a0118.js"><link rel="prefetch" href="/mostly-adequate-guide-chinese/assets/js/4.47caff48.js"><link rel="prefetch" href="/mostly-adequate-guide-chinese/assets/js/5.209b7f11.js"><link rel="prefetch" href="/mostly-adequate-guide-chinese/assets/js/6.5b22d12f.js"><link rel="prefetch" href="/mostly-adequate-guide-chinese/assets/js/7.9f81ff05.js"><link rel="prefetch" href="/mostly-adequate-guide-chinese/assets/js/8.95229e13.js"><link rel="prefetch" href="/mostly-adequate-guide-chinese/assets/js/9.2faab3a0.js">
    <link rel="stylesheet" href="/mostly-adequate-guide-chinese/assets/css/0.styles.e373d42e.css">
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-JNFKK7VGLS"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-JNFKK7VGLS');
    </script>
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/mostly-adequate-guide-chinese/" class="home-link router-link-active"><!----> <span class="site-name">JavaScript 函数式编程指南中文版</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/mostly-adequate-guide-chinese/ch1.html" class="sidebar-link">第 1 章：我们在做什么？</a></li><li><a href="/mostly-adequate-guide-chinese/ch2.html" class="sidebar-link">第 2 章: 一等公民的函数</a></li><li><a href="/mostly-adequate-guide-chinese/ch3.html" class="sidebar-link">第 3 章：纯函数的好处</a></li><li><a href="/mostly-adequate-guide-chinese/ch4.html" class="sidebar-link">第 4 章: 柯里化（curry）</a></li><li><a href="/mostly-adequate-guide-chinese/ch5.html" class="sidebar-link">第 5 章: 代码组合（compose）</a></li><li><a href="/mostly-adequate-guide-chinese/ch6.html" class="sidebar-link">第 6 章: 示例应用</a></li><li><a href="/mostly-adequate-guide-chinese/ch7.html" class="sidebar-link">第 7 章: Hindley-Milner 类型签名</a></li><li><a href="/mostly-adequate-guide-chinese/ch8.html" class="sidebar-link">第 8 章: 特百惠</a></li><li><a href="/mostly-adequate-guide-chinese/ch9.html" class="sidebar-link">第 9 章: Monad</a></li><li><a href="/mostly-adequate-guide-chinese/ch10.html" aria-current="page" class="active sidebar-link">第 10 章：Applicative Functor</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mostly-adequate-guide-chinese/ch10.html#应用-applicative-functor" class="sidebar-link">应用 applicative functor</a></li><li class="sidebar-sub-header"><a href="/mostly-adequate-guide-chinese/ch10.html#瓶中之船" class="sidebar-link">瓶中之船</a></li><li class="sidebar-sub-header"><a href="/mostly-adequate-guide-chinese/ch10.html#协调与激励" class="sidebar-link">协调与激励</a></li><li class="sidebar-sub-header"><a href="/mostly-adequate-guide-chinese/ch10.html#lift" class="sidebar-link">lift</a></li><li class="sidebar-sub-header"><a href="/mostly-adequate-guide-chinese/ch10.html#操作符" class="sidebar-link">操作符</a></li><li class="sidebar-sub-header"><a href="/mostly-adequate-guide-chinese/ch10.html#定律" class="sidebar-link">定律</a></li><li class="sidebar-sub-header"><a href="/mostly-adequate-guide-chinese/ch10.html#总结" class="sidebar-link">总结</a></li><li class="sidebar-sub-header"><a href="/mostly-adequate-guide-chinese/ch10.html#练习" class="sidebar-link">练习</a></li></ul></li><li><a href="/mostly-adequate-guide-chinese/ch11.html" class="sidebar-link">第 11 章：再转换一次，就很自然</a></li><li><a href="/mostly-adequate-guide-chinese/ch12.html" class="sidebar-link">第 12 章：遍历</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="第-10-章-applicative-functor"><a href="#第-10-章-applicative-functor" class="header-anchor">#</a> 第 10 章：Applicative Functor</h1> <h2 id="应用-applicative-functor"><a href="#应用-applicative-functor" class="header-anchor">#</a> 应用 applicative functor</h2> <p>考虑到其函数式的出身，<strong>applicative functor</strong> 这个名称堪称简单明了。函数式程序员最为人诟病的一点就是，总喜欢搞一些稀奇古怪的命名，比如 <code>mappend</code> 或者 <code>liftA4</code>。诚然，此类名称出现在数学实验室是再自然不过的，但是放在其他任何语境下，这些概念就都像是扮作达斯维达去汽车餐馆搞怪的人。（译者注：此处需要做些解释，1. 汽车餐馆（drive-thru）指的是那种不需要顾客下车就能提供服务的地方，比如麦当劳、星巴克等就会有这种 drive-thru；2. 达斯维达（Darth Vader）是《星球大战》系列主要反派角色，在美国大众文化中的有着广泛的影响力，其造型是很多人致敬模仿的对象；3. 由于 2 的缘故，美国一些星战迷会扮作 Darth Vader 去 drive-thru 点单，YouTube 上有不少这种<a href="https://www.youtube.com/watch?v=eKVJZAMUh_A" target="_blank" rel="noopener noreferrer">搞怪视频<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>；4. 作者使用这个“典故”是为了说明函数式里很多概念的名称有些“故弄玄虚”，而 applicative functor 是少数比较“正常”的。）</p> <p>无论如何，applicative 这个名字应该能够向我们表明一些事实，告诉我们作为一个接口，它能为我们带来什么：那就是让不同 functor 可以相互应用（apply）的能力。</p> <p>然而，你可能会问了，为何一个正常的、理性的人，比如你自己，会做这种“让不同 functor 相互应用”的事？而且，“相互应用”到底<em>是什么意思</em>？</p> <p>要回答这些问题，我们可以从下面这个场景讲起，可能你已经碰到过这种场景了。假设有两个同类型的 functor，我们想把这两者作为一个函数的两个参数传递过去来调用这个函数。简单的例子比如让两个 <code>Container</code> 的值相加：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 这样是行不通的，因为 2 和 3 都藏在瓶子里。</span>
<span class="token function">add</span><span class="token punctuation">(</span>Container<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Container<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//NaN</span>

<span class="token comment">// 使用可靠的 map 函数试试</span>
<span class="token keyword">var</span> container_of_add_2 <span class="token operator">=</span> <span class="token function">map</span><span class="token punctuation">(</span>add<span class="token punctuation">,</span> Container<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Container(add(2))</span>
</code></pre></div><p>这时候我们创建了一个 <code>Container</code>，它内部的值是一个局部调用的（partially applied）的函数。确切点讲就是，我们想让 <code>Container(add(2))</code> 中的 <code>add(2)</code> 应用到 <code>Container(3)</code> 中的 <code>3</code> 上来完成调用。也就是说，我们想把一个 functor 应用到另一个上。</p> <p>巧的是，完成这种任务的工具已经存在了，即 <code>chain</code> 函数。我们可以先 <code>chain</code> 然后再 <code>map</code> 那个局部调用的 <code>add(2)</code>，就像这样：</p> <div class="language-js extra-class"><pre class="language-js"><code>Container<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chain</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">two</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> Container<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span>two<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>只不过，这种方式有一个问题，那就是 monad 的顺序执行问题：所有的代码都只会在前一个 monad 执行完毕之后才执行。想想看，我们的这两个值足够强健且相互独立，如果仅仅为了满足 monad 的顺序要求而延迟 <code>Container(3)</code> 的创建，我觉得是非常没有必要的。</p> <p>事实上，当遇到这种问题的时候，要是能够无需借助这些不必要的函数和变量，以一种简明扼要的方式把一个 functor 的值应用到另一个上去就好了。</p> <h2 id="瓶中之船"><a href="#瓶中之船" class="header-anchor">#</a> 瓶中之船</h2> <img src="/mostly-adequate-guide-chinese/assets/img/ship_in_a_bottle.745408bb.jpg" alt="http://hollycarden.deviantart.com"> <p><code>ap</code> 就是这样一种函数，能够把一个 functor 的函数值应用到另一个 functor 的值上。把这句话快速地说上 5 遍。</p> <div class="language-js extra-class"><pre class="language-js"><code>Container<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ap</span><span class="token punctuation">(</span>Container<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Container(5)</span>

<span class="token comment">// all together now</span>
Container<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>add<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ap</span><span class="token punctuation">(</span>Container<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Container(5)</span>
</code></pre></div><p>这样就大功告成了，而且代码干净整洁。可以看到，<code>Container(3)</code> 从嵌套的 monad 函数的牢笼中释放了出来。需要再次强调的是，本例中的 <code>add</code> 是被 <code>map</code> 所局部调用（partially apply）的，所以 <code>add</code> 必须是一个 curry 函数。</p> <p>可以这样定义一个 <code>ap</code> 函数：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token class-name">Container</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">ap</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">other_container</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> other_container<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>__value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>记住，<code>this.__value</code> 是一个函数，将会接收另一个 functor 作为参数，所以我们只需 <code>map</code> 它。由此我们可以得出 applicative functor 的定义：</p> <blockquote><p>applicative functor 是实现了 <code>ap</code> 方法的 pointed functor</p></blockquote> <p>注意 <code>pointed</code> 这个前提，这是非常重要的一个前提，下面的例子会说明这一点。</p> <p>讲到这里，我已经感受到你的疑虑了（也或者是困惑和恐惧）；心态开放点嘛，<code>ap</code> 还是很有用的。在深入理解这个概念之前，我们先来探索一个特性。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token constant">F</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">F</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ap</span><span class="token punctuation">(</span><span class="token constant">F</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>这行代码翻译成人类语言就是，map 一个 <code>f</code> 等价于 <code>ap</code> 一个值为 <code>f</code> 的 functor。或者更好的译法是，你既可以把 <code>x</code> 放到容器里然后调用 <code>map(f)</code>，也可以同时让 <code>f</code> 和 <code>x</code> 发生 lift（参看第 8 章），然后对他们调用 <code>ap</code>。这让我们能够以一种从左到右的方式编写代码：</p> <div class="language-js extra-class"><pre class="language-js"><code>Maybe<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>add<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ap</span><span class="token punctuation">(</span>Maybe<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ap</span><span class="token punctuation">(</span>Maybe<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Maybe(5)</span>

Task<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>add<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ap</span><span class="token punctuation">(</span>Task<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ap</span><span class="token punctuation">(</span>Task<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Task(5)</span>
</code></pre></div><p>细心的读者可能发现了，上述代码中隐约有普通函数调用的影子。没关系，我们稍后会学习 <code>ap</code> 的 pointfree 版本；暂时先把这当作此类代码的推荐写法。通过使用 <code>of</code>，每一个值都被输送到了各个容器里的奇幻之地，就像是在另一个平行世界里，每个程序都可以是异步的或者是 null 或者随便什么值，而且不管是什么，<code>ap</code> 都能在这个平行世界里针对这些值应用各种各样的函数。这就像是在一个瓶子中造船。</p> <p>你注意到没？上例中我们使用了 <code>Task</code>，这是 applicative functor 主要的用武之地。现在我们来看一个更深入的例子。</p> <h2 id="协调与激励"><a href="#协调与激励" class="header-anchor">#</a> 协调与激励</h2> <p>假设我们要创建一个旅游网站，既需要获取游客目的地的列表，还需要获取地方事件的列表。这两个请求就是相互独立的 api 调用。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Http.get :: String -&gt; Task Error HTML</span>

<span class="token keyword">var</span> renderPage <span class="token operator">=</span> <span class="token function">curry</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">destinations<span class="token punctuation">,</span> events</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* render page */</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

Task<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>renderPage<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ap</span><span class="token punctuation">(</span>Http<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/destinations'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ap</span><span class="token punctuation">(</span>Http<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/events'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// Task(&quot;&lt;div&gt;some page with dest and events&lt;/div&gt;&quot;)</span>
</code></pre></div><p>两个请求将会同时立即执行，当两者的响应都返回之后，<code>renderPage</code> 就会被调用。这与 monad 版本的那种必须等待前一个任务完成才能继续执行后面的操作完全不同。本来我们就无需根据目的地来获取事件，因此也就不需要依赖顺序执行。</p> <p>再次强调，因为我们是使用局部调用的函数来达成上述结果的，所以必须要保证 <code>renderpage</code> 是 curry 函数，否则它就不会一直等到两个 <code>Task</code> 都完成。而且如果你碰巧自己做过类似的事，那你一定会感激 <code>applicative functor</code> 这个异常简洁的接口的。这就是那种能够让我们离“奇点”（singularity）更近一步的优美代码。</p> <p>再来看另外一个例子。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 帮助函数：</span>
<span class="token comment">// ==============</span>
<span class="token comment">//  $ :: String -&gt; IO DOM</span>
<span class="token keyword">var</span> <span class="token function-variable function">$</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">selector</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">IO</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">return</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//  getVal :: String -&gt; IO String</span>
<span class="token keyword">var</span> getVal <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token function">map</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span><span class="token function">prop</span><span class="token punctuation">(</span><span class="token string">'value'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> $<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Example:</span>
<span class="token comment">// ===============</span>
<span class="token comment">//  signIn :: String -&gt; String -&gt; Bool -&gt; User</span>
<span class="token keyword">var</span> signIn <span class="token operator">=</span> <span class="token function">curry</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">username<span class="token punctuation">,</span> password<span class="token punctuation">,</span> remember_me</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">/* signing in */</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token constant">IO</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>signIn<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ap</span><span class="token punctuation">(</span><span class="token function">getVal</span><span class="token punctuation">(</span><span class="token string">'#email'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ap</span><span class="token punctuation">(</span><span class="token function">getVal</span><span class="token punctuation">(</span><span class="token string">'#password'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ap</span><span class="token punctuation">(</span><span class="token constant">IO</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// IO({id: 3, email: &quot;gg@allin.com&quot;})</span>
</code></pre></div><p><code>signIn</code> 是一个接收 3 个参数的 curry 函数，因此我们需要调用 <code>ap</code> 3 次。在每一次的 <code>ap</code> 调用中，<code>signIn</code> 就收到一个参数然后运行，直到所有的参数都传进来，它也就执行完毕了。我们可以继续扩展这种模式，处理任意多的参数。另外，左边两个参数在使用 <code>getVal</code> 调用后自然而然地成为了一个 <code>IO</code>，但是最右边的那个却需要手动 <code>lift</code>，然后变成一个 <code>IO</code>，这是因为 <code>ap</code> 需要调用者及其参数都属于同一类型。</p> <h2 id="lift"><a href="#lift" class="header-anchor">#</a> lift</h2> <p>（译者注：此处原标题是“Bro, do you even lift?”，是一流行语，发源于健身圈，指质疑别人的健身方式和效果并显示优越感，后扩散至其他领域。再注：作者书中用了不少此类俚语或俗语，有时并非在使用俚语的本意，就像这句，完全就是为了好玩。另，关于 lift 的概念可参看第 8 章。）</p> <p>我们来试试以一种 pointfree 的方式调用 applicative functor。因为 <code>map</code> 等价于 <code>of/ap</code>，那么我们就可以定义无数个能够 <code>ap</code> 通用函数。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> liftA2 <span class="token operator">=</span> <span class="token function">curry</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">f<span class="token punctuation">,</span> functor1<span class="token punctuation">,</span> functor2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> functor1<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ap</span><span class="token punctuation">(</span>functor2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> liftA3 <span class="token operator">=</span> <span class="token function">curry</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">f<span class="token punctuation">,</span> functor1<span class="token punctuation">,</span> functor2<span class="token punctuation">,</span> functor3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> functor1<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ap</span><span class="token punctuation">(</span>functor2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ap</span><span class="token punctuation">(</span>functor3<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//liftA4, etc</span>
</code></pre></div><p><code>liftA2</code> 是个奇怪的名字，听起来像是破败工厂里挑剔的货运电梯，或者伪豪华汽车公司的个性车牌。不过你要是真正理解了，那么它的含义也就不证自明了：让那些小代码块发生 lift，成为 applicative functor 中的一员。</p> <p>刚开始我也觉得这种 2-3-4 的写法没什么意义，看起来又丑又没有必要，毕竟我们可以在 JavaScript 中检查函数的参数数量然后再动态地构造这样的函数。不过，局部调用（partially apply）<code>liftA(N)</code> 本身，有时也能发挥它的用处，这样的话，参数数量就固定了。</p> <p>来看看实际用例：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// checkEmail :: User -&gt; Either String Email</span>
<span class="token comment">// checkName :: User -&gt; Either String String</span>

<span class="token comment">//  createUser :: Email -&gt; String -&gt; IO User</span>
<span class="token keyword">var</span> createUser <span class="token operator">=</span> <span class="token function">curry</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">email<span class="token punctuation">,</span> name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* creating... */</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

Either<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>createUser<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ap</span><span class="token punctuation">(</span><span class="token function">checkEmail</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ap</span><span class="token punctuation">(</span><span class="token function">checkName</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Left(&quot;invalid email&quot;)</span>

<span class="token function">liftA2</span><span class="token punctuation">(</span>createUser<span class="token punctuation">,</span> <span class="token function">checkEmail</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">checkName</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Left(&quot;invalid email&quot;)</span>
</code></pre></div><p><code>createUser</code> 接收两个参数，因此我们使用的是 <code>liftA2</code>。上述两个语句是等价的，但是使用了 <code>liftA2</code> 的版本没有提到 <code>Either</code>，这就使得它更加通用灵活，因为不必与特定的数据类型耦合在一起。</p> <p>我们试试以这种方式重写前一个例子：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">liftA2</span><span class="token punctuation">(</span>add<span class="token punctuation">,</span> Maybe<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Maybe<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Maybe(5)</span>

<span class="token function">liftA2</span><span class="token punctuation">(</span>renderPage<span class="token punctuation">,</span> Http<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/destinations'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Http<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/events'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// Task(&quot;&lt;div&gt;some page with dest and events&lt;/div&gt;&quot;)</span>

<span class="token function">liftA3</span><span class="token punctuation">(</span>signIn<span class="token punctuation">,</span> <span class="token function">getVal</span><span class="token punctuation">(</span><span class="token string">'#email'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getVal</span><span class="token punctuation">(</span><span class="token string">'#password'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">IO</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// IO({id: 3, email: &quot;gg@allin.com&quot;})</span>
</code></pre></div><h2 id="操作符"><a href="#操作符" class="header-anchor">#</a> 操作符</h2> <p>在 haskell、scala、PureScript 以及 swift 等语言中，开发者可以创建自定义的中缀操作符（infix operators），所以你能看到到这样的语法：</p> <div class="language-hs extra-class"><pre class="language-hs"><code><span class="token comment">-- haskell</span>
<span class="token hvariable">add</span> <span class="token operator">&lt;$&gt;</span> <span class="token constant">Right</span> <span class="token number">2</span> <span class="token operator">&lt;*&gt;</span> <span class="token constant">Right</span> <span class="token number">3</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// JavaScript</span>
<span class="token function">map</span><span class="token punctuation">(</span>add<span class="token punctuation">,</span> <span class="token function">Right</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ap</span><span class="token punctuation">(</span><span class="token function">Right</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p><code>&lt;$&gt;</code> 就是 <code>map</code>（亦即 <code>fmap</code>），<code>&lt;*&gt;</code> 不过就是 <code>ap</code>。这样的语法使得开发者可以以一种更自然的风格来书写函数式应用，而且也能减少一些括号。</p> <h1 id="免费开瓶器"><a href="#免费开瓶器" class="header-anchor">#</a> 免费开瓶器</h1> <img src="/mostly-adequate-guide-chinese/assets/img/canopener.34732554.jpg" alt="http://breannabeckmeyer.com/drawing.html"> <p>我们尚未对衍生函数（derived function）着墨过多。不过看到本书介绍的所有这些接口都互相依赖并遵守一些定律，那么我们就可以根据一些强接口来定义一些弱接口了。</p> <p>比如，我们知道一个 applicative 首先是一个 functor，所以如果已经有一个 applicative 实例的话，毫无疑问可以依此定义一个 functor。</p> <p>这种完美的计算上的大和谐（computational harmony）之所以存在，是因为我们在跟一个数学“框架”打交道。哪怕是莫扎特在小时候就下载了 ableton（译者注：一款专业的音乐制作软件），他的钢琴也不可能弹得更好。</p> <p>前面提到过，<code>of/ap</code> 等价于 <code>map</code>，那么我们就可以利用这点来定义 <code>map</code>：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 从 of/ap 衍生出的 map</span>
<span class="token class-name">X</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">map</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">f</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>constructor<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ap</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>monad 可以说是处在食物链的顶端，因此如果已经有了一个 <code>chain</code> 函数，那么就可以免费得到 functor 和 applicative：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 从 chain 衍生出的 map</span>
<span class="token class-name">X</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">map</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">f</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> m <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> m<span class="token punctuation">.</span><span class="token function">chain</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">a</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> m<span class="token punctuation">.</span>constructor<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token function">f</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 从 chain/map 衍生出的 ap</span>
<span class="token class-name">X</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">ap</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">other</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">chain</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">f</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> other<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>定义一个 monad，就既能得到 applicative 也能得到 functor。这一点非常强大，相当于这些“开瓶器”全都是免费的！我们甚至可以审查一个数据类型，然后自动化这个过程。</p> <p>应该要指出来的一点是，<code>ap</code> 的魅力有一部分就来自于并行的能力，所以通过 <code>chain</code> 来定义它就失去了这种优化。即便如此，开发者在设计出最佳实现的过程中就能有一个立即可用的接口，也是很好的。</p> <p>为啥不直接使用 monad？因为最好用合适的力量来解决合适的问题，一分不多，一分不少。这样就能通过排除可能的功能性来做到最小化认知负荷。因为这个原因，相比 monad，我们更倾向于使用 applicative。</p> <p>向下的嵌套结构使得 monad 拥有串行计算、变量赋值和暂缓后续执行等独特的能力。不过见识到 applicative 的实际用例之后，你就不必再考虑上面这些问题了。</p> <p>下面，来看看理论知识。</p> <h2 id="定律"><a href="#定律" class="header-anchor">#</a> 定律</h2> <p>就像我们探索过的其他数学结构一样，我们在日常编码中也依赖 applicative functor 一些有用的特性。首先，你应该知道 applicative functor 是“组合关闭”（closed under composition）的，意味着 <code>ap</code> 永远不会改变容器类型（另一个胜过 monad 的原因）。这并不是说我们无法拥有多种不同的作用——我们还是可以把不同的类型压栈的，只不过我们知道它们将会在整个应用的过程中保持不变。</p> <p>下面的例子可以说明这一点：</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">var</span> tOfM <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span>Task<span class="token punctuation">.</span>of<span class="token punctuation">,</span> Maybe<span class="token punctuation">.</span>of<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">liftA2</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span>concat<span class="token punctuation">,</span> <span class="token function">tOfM</span><span class="token punctuation">(</span><span class="token string">'Rainy Days and Mondays'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">tOfM</span><span class="token punctuation">(</span><span class="token string">' always get me down'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// Task(Maybe(Rainy Days and Mondays always get me down))</span>
</code></pre></div><p>你看，不必担心不同的类型会混合在一起。</p> <p>该去看看我们最喜欢的范畴学定律了：<em>同一律</em>（identity）。</p> <h3 id="同一律-identity"><a href="#同一律-identity" class="header-anchor">#</a> 同一律（identity）</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 同一律</span>
<span class="token constant">A</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ap</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token operator">==</span> v
</code></pre></div><p>是的，对一个 functor 应用 <code>id</code> 函数不会改变 <code>v</code> 里的值。比如：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> v <span class="token operator">=</span> Identity<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">&quot;Pillow Pets&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Identity<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ap</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token operator">==</span> v
</code></pre></div><p><code>Identity.of(id)</code> 的“无用性”让我不禁莞尔。这里有意思的一点是，就像我们之前证明了的，<code>of/ap</code> 等价于 <code>map</code>，因此这个同一律遵循的是 functor 的同一律：<code>map(id) == id</code>。</p> <p>使用这些定律的优美之处在于，就像一个富有激情的幼儿园健身教练让所有的小朋友都能愉快地一块玩耍一样，它们能够强迫所有的接口都能完美结合。</p> <h3 id="同态-homomorphism"><a href="#同态-homomorphism" class="header-anchor">#</a> 同态（homomorphism）</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 同态</span>
<span class="token constant">A</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ap</span><span class="token punctuation">(</span><span class="token constant">A</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">A</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token function">f</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p><em>同态</em>就是一个能够保持结构的映射（structure preserving map）。实际上，functor 就是一个在不同范畴间的同态，因为 functor 在经过映射之后保持了原始范畴的结构。</p> <p>事实上，我们不过是把普通的函数和值放进了一个容器，然后在里面进行各种计算。所以，不管是把所有的计算都放在容器里（等式左边），还是先在外面进行计算然后再放到容器里（等式右边），其结果都是一样的。</p> <p>一个简单例子：</p> <div class="language-js extra-class"><pre class="language-js"><code>Either<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span>toUpper<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ap</span><span class="token punctuation">(</span>Either<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">&quot;oreos&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> Either<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span><span class="token function">toUpper</span><span class="token punctuation">(</span><span class="token string">&quot;oreos&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="互换-interchange"><a href="#互换-interchange" class="header-anchor">#</a> 互换（interchange）</h3> <p>互换（interchange）表明的是选择让函数在 <code>ap</code> 的左边还是右边发生 lift 是无关紧要的。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 互换</span>
v<span class="token punctuation">.</span><span class="token function">ap</span><span class="token punctuation">(</span><span class="token constant">A</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">A</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">f</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">f</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ap</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
</code></pre></div><p>这里有个例子：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> v <span class="token operator">=</span> Task<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span>reverse<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token string">'Sparklehorse'</span><span class="token punctuation">;</span>

v<span class="token punctuation">.</span><span class="token function">ap</span><span class="token punctuation">(</span>Task<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> Task<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">f</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">f</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ap</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
</code></pre></div><h3 id="组合-composition"><a href="#组合-composition" class="header-anchor">#</a> 组合（composition）</h3> <p>最后是组合。组合不过是在检查标准的函数组合是否适用于容器内部的函数调用。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 组合</span>
<span class="token constant">A</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>compose<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ap</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ap</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ap</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span> <span class="token operator">==</span> u<span class="token punctuation">.</span><span class="token function">ap</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span><span class="token function">ap</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> u <span class="token operator">=</span> <span class="token constant">IO</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span>toUpper<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> v <span class="token operator">=</span> <span class="token constant">IO</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token string">&quot;&amp; beyond&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> w <span class="token operator">=</span> <span class="token constant">IO</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">&quot;blood bath &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token constant">IO</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span>compose<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ap</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ap</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ap</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span> <span class="token operator">==</span> u<span class="token punctuation">.</span><span class="token function">ap</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span><span class="token function">ap</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>处理多个 functor 作为参数的情况，是 applicative functor 一个非常好的应用场景。借助 applicative functor，我们能够在 functor 的世界里调用函数。尽管已经可以通过 monad 达到这个目的，但在不需要 monad 的特定功能的时候，我们还是更倾向于使用 applicative functor。</p> <p>至此我们已经基本介绍完容器的 api 了，我们学会了如何对函数调用 <code>map</code>、<code>chain</code> 和 <code>ap</code>。下一章，我们将学习如何更好地处理多个 functor，以及如何以一种原则性的方式拆解它们。</p> <p><a href="/mostly-adequate-guide-chinese/ch11.html">Chapter 11: Transformation Again, Naturally</a></p> <h2 id="练习"><a href="#练习" class="header-anchor">#</a> 练习</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./support'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> Task <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'data.task'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> _ <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'ramda'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 模拟浏览器的 localStorage 对象</span>
<span class="token keyword">var</span> localStorage <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>



<span class="token comment">// 练习 1</span>
<span class="token comment">// ==========</span>
<span class="token comment">// 写一个函数，使用 Maybe 和 ap() 实现让两个可能是 null 的数值相加。</span>

<span class="token comment">//  ex1 :: Number -&gt; Number -&gt; Maybe Number</span>
<span class="token keyword">var</span> <span class="token function-variable function">ex1</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token comment">// 练习 2</span>
<span class="token comment">// ==========</span>
<span class="token comment">// 写一个函数，接收两个 Maybe 为参数，让它们相加。使用 liftA2 代替 ap()。</span>

<span class="token comment">//  ex2 :: Maybe Number -&gt; Maybe Number -&gt; Maybe Number</span>
<span class="token keyword">var</span> ex2 <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>



<span class="token comment">// 练习 3</span>
<span class="token comment">// ==========</span>
<span class="token comment">// 运行 getPost(n) 和 getComments(n)，两者都运行完毕后执行渲染页面的操作。（参数 n 可以是任意值）。</span>

<span class="token keyword">var</span> makeComments <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">acc<span class="token punctuation">,</span> c</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">return</span> acc<span class="token operator">+</span><span class="token string">&quot;&lt;li&gt;&quot;</span><span class="token operator">+</span>c<span class="token operator">+</span><span class="token string">&quot;&lt;/li&gt;&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> render <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">curry</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">p<span class="token punctuation">,</span> cs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token string">&quot;&lt;div&gt;&quot;</span><span class="token operator">+</span>p<span class="token punctuation">.</span>title<span class="token operator">+</span><span class="token string">&quot;&lt;/div&gt;&quot;</span><span class="token operator">+</span><span class="token function">makeComments</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//  ex3 :: Task Error HTML</span>
<span class="token keyword">var</span> ex3 <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>



<span class="token comment">// 练习 4</span>
<span class="token comment">// ==========</span>
<span class="token comment">// 写一个 IO，从缓存中读取 player1 和 player2，然后开始游戏。</span>

localStorage<span class="token punctuation">.</span>player1 <span class="token operator">=</span> <span class="token string">&quot;toby&quot;</span><span class="token punctuation">;</span>
localStorage<span class="token punctuation">.</span>player2 <span class="token operator">=</span> <span class="token string">&quot;sally&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> <span class="token function-variable function">getCache</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">IO</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> localStorage<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> game <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">curry</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">p1<span class="token punctuation">,</span> p2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> p1 <span class="token operator">+</span> <span class="token string">' vs '</span> <span class="token operator">+</span> p2<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//  ex4 :: IO String</span>
<span class="token keyword">var</span> ex4 <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>





<span class="token comment">// 帮助函数</span>
<span class="token comment">// =====================</span>

<span class="token keyword">function</span> <span class="token function">getPost</span><span class="token punctuation">(</span><span class="token parameter">i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Task</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">rej<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">res</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> i<span class="token punctuation">,</span> <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'Love them futures'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">getComments</span><span class="token punctuation">(</span><span class="token parameter">i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Task</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">rej<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">res</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;This book should be illegal&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Monads are like space burritos&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/mostly-adequate-guide-chinese/ch9.html" class="prev">
        第 9 章: Monad
      </a></span> <span class="next"><a href="/mostly-adequate-guide-chinese/ch11.html">
        第 11 章：再转换一次，就很自然
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/mostly-adequate-guide-chinese/assets/js/app.e22f068f.js" defer></script><script src="/mostly-adequate-guide-chinese/assets/js/2.35b03a7f.js" defer></script><script src="/mostly-adequate-guide-chinese/assets/js/10.9ff47bf3.js" defer></script>
  </body>
</html>
