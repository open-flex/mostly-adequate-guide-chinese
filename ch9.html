<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>第 9 章: Monad | JavaScript 函数式编程指南中文版</title>
    
    <meta name="description" content="">
    
    <link rel="preload" href="/mostly-adequate-guide-chinese/assets/css/0.styles.e373d42e.css" as="style"><link rel="preload" href="/mostly-adequate-guide-chinese/assets/js/app.e22f068f.js" as="script"><link rel="preload" href="/mostly-adequate-guide-chinese/assets/js/2.35b03a7f.js" as="script"><link rel="preload" href="/mostly-adequate-guide-chinese/assets/js/4.47caff48.js" as="script"><link rel="prefetch" href="/mostly-adequate-guide-chinese/assets/js/10.9ff47bf3.js"><link rel="prefetch" href="/mostly-adequate-guide-chinese/assets/js/11.1613d626.js"><link rel="prefetch" href="/mostly-adequate-guide-chinese/assets/js/12.5037078b.js"><link rel="prefetch" href="/mostly-adequate-guide-chinese/assets/js/13.54fbdcfe.js"><link rel="prefetch" href="/mostly-adequate-guide-chinese/assets/js/14.85525b84.js"><link rel="prefetch" href="/mostly-adequate-guide-chinese/assets/js/15.b0675b5a.js"><link rel="prefetch" href="/mostly-adequate-guide-chinese/assets/js/16.44cb92b7.js"><link rel="prefetch" href="/mostly-adequate-guide-chinese/assets/js/17.15cbb2bc.js"><link rel="prefetch" href="/mostly-adequate-guide-chinese/assets/js/18.9af46e61.js"><link rel="prefetch" href="/mostly-adequate-guide-chinese/assets/js/19.8afc0231.js"><link rel="prefetch" href="/mostly-adequate-guide-chinese/assets/js/3.c39a0118.js"><link rel="prefetch" href="/mostly-adequate-guide-chinese/assets/js/5.209b7f11.js"><link rel="prefetch" href="/mostly-adequate-guide-chinese/assets/js/6.5b22d12f.js"><link rel="prefetch" href="/mostly-adequate-guide-chinese/assets/js/7.9f81ff05.js"><link rel="prefetch" href="/mostly-adequate-guide-chinese/assets/js/8.95229e13.js"><link rel="prefetch" href="/mostly-adequate-guide-chinese/assets/js/9.2faab3a0.js">
    <link rel="stylesheet" href="/mostly-adequate-guide-chinese/assets/css/0.styles.e373d42e.css">
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-JNFKK7VGLS"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-JNFKK7VGLS');
    </script>
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/mostly-adequate-guide-chinese/" class="home-link router-link-active"><!----> <span class="site-name">JavaScript 函数式编程指南中文版</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/mostly-adequate-guide-chinese/ch1.html" class="sidebar-link">第 1 章：我们在做什么？</a></li><li><a href="/mostly-adequate-guide-chinese/ch2.html" class="sidebar-link">第 2 章: 一等公民的函数</a></li><li><a href="/mostly-adequate-guide-chinese/ch3.html" class="sidebar-link">第 3 章：纯函数的好处</a></li><li><a href="/mostly-adequate-guide-chinese/ch4.html" class="sidebar-link">第 4 章: 柯里化（curry）</a></li><li><a href="/mostly-adequate-guide-chinese/ch5.html" class="sidebar-link">第 5 章: 代码组合（compose）</a></li><li><a href="/mostly-adequate-guide-chinese/ch6.html" class="sidebar-link">第 6 章: 示例应用</a></li><li><a href="/mostly-adequate-guide-chinese/ch7.html" class="sidebar-link">第 7 章: Hindley-Milner 类型签名</a></li><li><a href="/mostly-adequate-guide-chinese/ch8.html" class="sidebar-link">第 8 章: 特百惠</a></li><li><a href="/mostly-adequate-guide-chinese/ch9.html" aria-current="page" class="active sidebar-link">第 9 章: Monad</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mostly-adequate-guide-chinese/ch9.html#pointed-functor" class="sidebar-link">pointed functor</a></li><li class="sidebar-sub-header"><a href="/mostly-adequate-guide-chinese/ch9.html#混合比喻" class="sidebar-link">混合比喻</a></li><li class="sidebar-sub-header"><a href="/mostly-adequate-guide-chinese/ch9.html#chain-函数" class="sidebar-link">chain 函数</a></li><li class="sidebar-sub-header"><a href="/mostly-adequate-guide-chinese/ch9.html#炫耀" class="sidebar-link">炫耀</a></li><li class="sidebar-sub-header"><a href="/mostly-adequate-guide-chinese/ch9.html#总结" class="sidebar-link">总结</a></li><li class="sidebar-sub-header"><a href="/mostly-adequate-guide-chinese/ch9.html#练习" class="sidebar-link">练习</a></li></ul></li><li><a href="/mostly-adequate-guide-chinese/ch10.html" class="sidebar-link">第 10 章：Applicative Functor</a></li><li><a href="/mostly-adequate-guide-chinese/ch11.html" class="sidebar-link">第 11 章：再转换一次，就很自然</a></li><li><a href="/mostly-adequate-guide-chinese/ch12.html" class="sidebar-link">第 12 章：遍历</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="第-9-章-monad"><a href="#第-9-章-monad" class="header-anchor">#</a> 第 9 章: Monad</h1> <h2 id="pointed-functor"><a href="#pointed-functor" class="header-anchor">#</a> pointed functor</h2> <p>在继续后面的内容之前，我得向你坦白一件事：关于我们先前创建的容器类型上的 <code>of</code> 方法，我并没有说出它的全部实情。真实情况是，<code>of</code> 方法不是用来避免使用 <code>new</code> 关键字的，而是用来把值放到<em>默认最小化上下文</em>（default minimal context）中的。是的，<code>of</code> 没有真正地取代构造器——它是一个我们称之为 <em>pointed</em> 的重要接口的一部分。</p> <blockquote><p><em>pointed functor</em> 是实现了 <code>of</code> 方法的 functor。</p></blockquote> <p>这里的关键是把任意值丢到容器里然后开始到处使用 <code>map</code> 的能力。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token constant">IO</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">&quot;tetris&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token string">&quot; master&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// IO(&quot;tetris master&quot;)</span>

Maybe<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">1336</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Maybe(1337)</span>

Task<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span><span class="token function">prop</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Task([2,3])</span>

Either<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">&quot;The past, present and future walk into a bar...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>
  <span class="token function">concat</span><span class="token punctuation">(</span><span class="token string">&quot;it was tense.&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Right(&quot;The past, present and future walk into a bar...it was tense.&quot;)</span>
</code></pre></div><p>如果你还记得，<code>IO</code> 和 <code>Task</code> 的构造器接受一个函数作为参数，而 <code>Maybe</code> 和 <code>Either</code> 的构造器可以接受任意值。实现这种接口的动机是，我们希望能有一种通用、一致的方式往 functor 里填值，而且中间不会涉及到复杂性，也不会涉及到对构造器的特定要求。“默认最小化上下文”这个术语可能不够精确，但是却很好地传达了这种理念：我们希望容器类型里的任意值都能发生 <code>lift</code>，然后像所有的 functor 那样再 <code>map</code> 出去。</p> <p>有件很重要的事我必须得在这里纠正，那就是，<code>Left.of</code> 没有任何道理可言，包括它的双关语也是。每个 functor 都要有一种把值放进去的方式，对 <code>Either</code> 来说，它的方式就是 <code>new Right(x)</code>。我们为 <code>Right</code> 定义 <code>of</code> 的原因是，如果一个类型容器<em>可以</em> <code>map</code>，那它就<em>应该</em> <code>map</code>。看上面的例子，你应该会对 <code>of</code> 通常的工作模式有一个直观的印象，而 <code>Left</code> 破坏了这种模式。</p> <p>你可能已经听说过 <code>pure</code>、<code>point</code>、<code>unit</code> 和 <code>return</code> 之类的函数了，它们都是 <code>of</code> 这个史上最神秘函数的不同名称（译者注：此处原文是“international function of mystery”，源自恶搞《007》的电影 <em>Austin Powers: International Man of Mystery</em>，中译名《王牌大贱谍》）。<code>of</code> 将在我们开始使用 monad 的时候显示其重要性，因为后面你会看到，手动把值放回容器是我们自己的责任。</p> <p>要避免 <code>new</code> 关键字，可以借助一些标准的 JavaScript 技巧或者类库达到目的。所以从这里开始，我们就利用这些技巧或类库，像一个负责任的成年人那样使用 <code>of</code>。我推荐使用 <code>folktale</code>、<code>ramda</code> 或 <code>fantasy-land</code> 里的 functor 实例，因为它们同时提供了正确的 <code>of</code> 方法和不依赖 <code>new</code> 的构造器。</p> <h2 id="混合比喻"><a href="#混合比喻" class="header-anchor">#</a> 混合比喻</h2> <img src="/mostly-adequate-guide-chinese/assets/img/onion.0292d787.png" alt="http://www.organicchemistry.com/wp-content/uploads/BPOCchapter6-6htm-41.png"> <p>你看，除了太空墨西哥卷（如果你听说过这个传言的话）（译者注：此处的传言似乎是说一个叫 Chris Hadfield 的宇航员在国际空间站做墨西哥卷的事，<a href="https://www.youtube.com/watch?v=f8-UKqGZ_hs" target="_blank" rel="noopener noreferrer">视频链接<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>），monad 还被喻为洋葱。让我以一个常见的场景来说明这点：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Support</span>
<span class="token comment">// ===========================</span>
<span class="token keyword">var</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//  readFile :: String -&gt; IO String</span>
<span class="token keyword">var</span> <span class="token function-variable function">readFile</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">filename</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">IO</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">//  print :: String -&gt; IO String</span>
<span class="token keyword">var</span> <span class="token function-variable function">print</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">IO</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> x<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Example</span>
<span class="token comment">// ===========================</span>
<span class="token comment">//  cat :: IO (IO String)</span>
<span class="token keyword">var</span> cat <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token function">map</span><span class="token punctuation">(</span>print<span class="token punctuation">)</span><span class="token punctuation">,</span> readFile<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">cat</span><span class="token punctuation">(</span><span class="token string">&quot;.git/config&quot;</span><span class="token punctuation">)</span>
<span class="token comment">// IO(IO(&quot;[core]\nrepositoryformatversion = 0\n&quot;))</span>
</code></pre></div><p>这里我们得到的是一个 <code>IO</code>，只不过它陷进了另一个 <code>IO</code>。要想使用它，我们必须这样调用： <code>map(map(f))</code>；要想观察它的作用，必须这样： <code>unsafePerformIO().unsafePerformIO()</code>。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//  cat :: String -&gt; IO (IO String)</span>
<span class="token keyword">var</span> cat <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token function">map</span><span class="token punctuation">(</span>print<span class="token punctuation">)</span><span class="token punctuation">,</span> readFile<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//  catFirstChar :: String -&gt; IO (IO String)</span>
<span class="token keyword">var</span> catFirstChar <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token function">map</span><span class="token punctuation">(</span>head<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cat<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">catFirstChar</span><span class="token punctuation">(</span><span class="token string">&quot;.git/config&quot;</span><span class="token punctuation">)</span>
<span class="token comment">// IO(IO(&quot;[&quot;))</span>
</code></pre></div><p>尽管在应用中把这两个作用打包在一起没什么不好的，但总感觉像是在穿着两套防护服工作，结果就形成一个稀奇古怪的 API。再来看另一种情况：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//  safeProp :: Key -&gt; {Key: a} -&gt; Maybe a</span>
<span class="token keyword">var</span> safeProp <span class="token operator">=</span> <span class="token function">curry</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Maybe</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//  safeHead :: [a] -&gt; Maybe a</span>
<span class="token keyword">var</span> safeHead <span class="token operator">=</span> <span class="token function">safeProp</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//  firstAddressStreet :: User -&gt; Maybe (Maybe (Maybe Street) )</span>
<span class="token keyword">var</span> firstAddressStreet <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span>
  <span class="token function">map</span><span class="token punctuation">(</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token function">safeProp</span><span class="token punctuation">(</span><span class="token string">'street'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">map</span><span class="token punctuation">(</span>safeHead<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">safeProp</span><span class="token punctuation">(</span><span class="token string">'addresses'</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">firstAddressStreet</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span><span class="token literal-property property">addresses</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token literal-property property">street</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'Mulburry'</span><span class="token punctuation">,</span> <span class="token literal-property property">number</span><span class="token operator">:</span> <span class="token number">8402</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">postcode</span><span class="token operator">:</span> <span class="token string">&quot;WC2N&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Maybe(Maybe(Maybe({name: 'Mulburry', number: 8402})))</span>
</code></pre></div><p>这里的 functor 同样是嵌套的，函数中三个可能的失败都用了 <code>Maybe</code> 做预防也很干净整洁，但是要让最后的调用者调用三次 <code>map</code> 才能取到值未免也太无礼了点——我们和它才刚刚见面而已。这种嵌套 functor 的模式会时不时地出现，而且是 monad 的主要使用场景。</p> <p>我说过 monad 像洋葱，那是因为当我们用 <code>map</code> 剥开嵌套的 functor 以获取它里面的值的时候，就像剥洋葱一样让人忍不住想哭。不过，我们可以擦干眼泪，做个深呼吸，然后使用一个叫作 <code>join</code> 的方法。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> mmo <span class="token operator">=</span> Maybe<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>Maybe<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">&quot;nunchucks&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Maybe(Maybe(&quot;nunchucks&quot;))</span>

mmo<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Maybe(&quot;nunchucks&quot;)</span>

<span class="token keyword">var</span> ioio <span class="token operator">=</span> <span class="token constant">IO</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token constant">IO</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">&quot;pizza&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// IO(IO(&quot;pizza&quot;))</span>

ioio<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// IO(&quot;pizza&quot;)</span>

<span class="token keyword">var</span> ttt <span class="token operator">=</span> Task<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>Task<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>Task<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">&quot;sewers&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Task(Task(Task(&quot;sewers&quot;)));</span>

ttt<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// Task(Task(&quot;sewers&quot;))</span>
</code></pre></div><p>如果有两层相同类型的嵌套，那么就可以用 <code>join</code> 把它们压扁到一块去。这种结合的能力，functor 之间的联姻，就是 monad 之所以成为 monad 的原因。来看看它更精确的完整定义：</p> <blockquote><p>monad 是可以变扁（flatten）的 pointed functor。</p></blockquote> <p>一个 functor，只要它定义个了一个 <code>join</code> 方法和一个 <code>of</code> 方法，并遵守一些定律，那么它就是一个 monad。<code>join</code> 的实现并不太复杂，我们来为 <code>Maybe</code> 定义一个：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token class-name">Maybe</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">join</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isNothing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> Maybe<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>__value<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>看，就像子宫里双胞胎中的一个吃掉另一个那么简单。如果有一个 <code>Maybe(Maybe(x))</code>，那么 <code>.__value</code> 将会移除多余的一层，然后我们就能安心地从那开始进行 <code>map</code>。要不然，我们就将会只有一个 <code>Maybe</code>，因为从一开始就没有任何东西被 <code>map</code> 调用。</p> <p>既然已经有了 <code>join</code> 方法，我们把 monad 魔法作用到 <code>firstAddressStreet</code> 例子上，看看它的实际作用：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//  join :: Monad m =&gt; m (m a) -&gt; m a</span>
<span class="token keyword">var</span> <span class="token function-variable function">join</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">mma</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">return</span> mma<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token comment">//  firstAddressStreet :: User -&gt; Maybe Street</span>
<span class="token keyword">var</span> firstAddressStreet <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span>
  join<span class="token punctuation">,</span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token function">safeProp</span><span class="token punctuation">(</span><span class="token string">'street'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> join<span class="token punctuation">,</span> <span class="token function">map</span><span class="token punctuation">(</span>safeHead<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">safeProp</span><span class="token punctuation">(</span><span class="token string">'addresses'</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">firstAddressStreet</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span><span class="token literal-property property">addresses</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token literal-property property">street</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'Mulburry'</span><span class="token punctuation">,</span> <span class="token literal-property property">number</span><span class="token operator">:</span> <span class="token number">8402</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">postcode</span><span class="token operator">:</span> <span class="token string">&quot;WC2N&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Maybe({name: 'Mulburry', number: 8402})</span>
</code></pre></div><p>只要遇到嵌套的 <code>Maybe</code>，就加一个 <code>join</code>，防止它们从手中溜走。我们对 <code>IO</code> 也这么做试试看，感受下这种感觉。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token class-name">IO</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">join</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">unsafePerformIO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>同样是简单地移除了一层容器。注意，我们还没有提及纯粹性的问题，仅仅是移除过度紧缩的包裹中的一层而已。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//  log :: a -&gt; IO a</span>
<span class="token keyword">var</span> <span class="token function-variable function">log</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">IO</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> x<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//  setStyle :: Selector -&gt; CSSProps -&gt; IO DOM</span>
<span class="token keyword">var</span> setStyle <span class="token operator">=</span> <span class="token function">curry</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">sel<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">IO</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">jQuery</span><span class="token punctuation">(</span>sel<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//  getItem :: String -&gt; IO String</span>
<span class="token keyword">var</span> <span class="token function-variable function">getItem</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">IO</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">//  applyPreferences :: String -&gt; IO DOM</span>
<span class="token keyword">var</span> applyPreferences <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span>
  join<span class="token punctuation">,</span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token function">setStyle</span><span class="token punctuation">(</span><span class="token string">'#main'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> join<span class="token punctuation">,</span> <span class="token function">map</span><span class="token punctuation">(</span>log<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span>parse<span class="token punctuation">)</span><span class="token punctuation">,</span> getItem
<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token function">applyPreferences</span><span class="token punctuation">(</span><span class="token string">'preferences'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unsafePerformIO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Object {backgroundColor: &quot;green&quot;}</span>
<span class="token comment">// &lt;div style=&quot;background-color: 'green'&quot;/&gt;</span>
</code></pre></div><p><code>getItem</code> 返回了一个 <code>IO String</code>，所以可以直接用 <code>map</code> 来解析它。<code>log</code> 和 <code>setStyle</code> 返回的都是 <code>IO</code>，所以必须要使用 <code>join</code> 来保证这里边的嵌套处于控制之中。</p> <h2 id="chain-函数"><a href="#chain-函数" class="header-anchor">#</a> chain 函数</h2> <p>（译者注：此处标题原文是“My chain hits my chest”，是英国歌手 M.I.A 单曲 <em>Bad Girls</em> 的一句歌词。据说这首歌有体现女权主义。）</p> <img src="/mostly-adequate-guide-chinese/assets/img/chain.584ef01b.jpg" alt="chain"> <p>你可能已经从上面的例子中注意到这种模式了：我们总是在紧跟着 <code>map</code> 的后面调用 <code>join</code>。让我们把这个行为抽象到一个叫做 <code>chain</code> 的函数里。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//  chain :: Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b</span>
<span class="token keyword">var</span> chain <span class="token operator">=</span> <span class="token function">curry</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">f<span class="token punctuation">,</span> m</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> m<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 或者 compose(join, map(f))(m)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这里仅仅是把 map/join 套餐打包到一个单独的函数中。如果你之前了解过 monad，那你可能已经看出来 <code>chain</code> 叫做 <code>&gt;&gt;=</code>（读作 bind）或者 <code>flatMap</code>；都是同一个概念的不同名称罢了。我个人认为 <code>flatMap</code> 是最准确的名称，但本书还是坚持使用 <code>chain</code>，因为它是 JS 里接受程度最高的一个。我们用 <code>chain</code> 重构下上面两个例子：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// map/join</span>
<span class="token keyword">var</span> firstAddressStreet <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span>
  join<span class="token punctuation">,</span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token function">safeProp</span><span class="token punctuation">(</span><span class="token string">'street'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> join<span class="token punctuation">,</span> <span class="token function">map</span><span class="token punctuation">(</span>safeHead<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">safeProp</span><span class="token punctuation">(</span><span class="token string">'addresses'</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// chain</span>
<span class="token keyword">var</span> firstAddressStreet <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span>
  <span class="token function">chain</span><span class="token punctuation">(</span><span class="token function">safeProp</span><span class="token punctuation">(</span><span class="token string">'street'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">chain</span><span class="token punctuation">(</span>safeHead<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">safeProp</span><span class="token punctuation">(</span><span class="token string">'addresses'</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>



<span class="token comment">// map/join</span>
<span class="token keyword">var</span> applyPreferences <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span>
  join<span class="token punctuation">,</span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token function">setStyle</span><span class="token punctuation">(</span><span class="token string">'#main'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> join<span class="token punctuation">,</span> <span class="token function">map</span><span class="token punctuation">(</span>log<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span>parse<span class="token punctuation">)</span><span class="token punctuation">,</span> getItem
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// chain</span>
<span class="token keyword">var</span> applyPreferences <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span>
  <span class="token function">chain</span><span class="token punctuation">(</span><span class="token function">setStyle</span><span class="token punctuation">(</span><span class="token string">'#main'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">chain</span><span class="token punctuation">(</span>log<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span>parse<span class="token punctuation">)</span><span class="token punctuation">,</span> getItem
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>我把所有的 <code>map/join</code> 都替换为了 <code>chain</code>，这样代码就显得整洁了些。整洁固然是好事，但 <code>chain</code> 的能力却不止于此——它更多的是龙卷风而不是吸尘器。因为 <code>chain</code> 可以轻松地嵌套多个作用，因此我们就能以一种纯函数式的方式来表示 <em>序列</em>（sequence） 和 <em>变量赋值</em>（variable assignment）。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// getJSON :: Url -&gt; Params -&gt; Task JSON</span>
<span class="token comment">// querySelector :: Selector -&gt; IO DOM</span>


<span class="token function">getJSON</span><span class="token punctuation">(</span><span class="token string">'/authenticate'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">username</span><span class="token operator">:</span> <span class="token string">'stale'</span><span class="token punctuation">,</span> <span class="token literal-property property">password</span><span class="token operator">:</span> <span class="token string">'crackers'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">chain</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">user</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">getJSON</span><span class="token punctuation">(</span><span class="token string">'/friends'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">user_id</span><span class="token operator">:</span> user<span class="token punctuation">.</span>id<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Task([{name: 'Seimith', id: 14}, {name: 'Ric', id: 39}]);</span>


<span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;input.username&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chain</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">uname</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;input.email&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chain</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">email</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token constant">IO</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>
      <span class="token string">&quot;Welcome &quot;</span> <span class="token operator">+</span> uname<span class="token punctuation">.</span>value <span class="token operator">+</span> <span class="token string">&quot; &quot;</span> <span class="token operator">+</span> <span class="token string">&quot;prepare for spam at &quot;</span> <span class="token operator">+</span> email<span class="token punctuation">.</span>value
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// IO(&quot;Welcome Olivia prepare for spam at olivia@tremorcontrol.net&quot;);</span>


Maybe<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chain</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">three</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> Maybe<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span>three<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Maybe(5);</span>


Maybe<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chain</span><span class="token punctuation">(</span><span class="token function">safeProp</span><span class="token punctuation">(</span><span class="token string">'address'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chain</span><span class="token punctuation">(</span><span class="token function">safeProp</span><span class="token punctuation">(</span><span class="token string">'street'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Maybe(null);</span>
</code></pre></div><p>本来我们可以用 <code>compose</code> 写上面的例子，但这将需要几个帮助函数，而且这种风格怎么说都要通过闭包进行明确的变量赋值。相反，我们使用了插入式的 <code>chain</code>。顺便说一下，<code>chain</code> 可以自动从任意类型的 <code>map</code> 和 <code>join</code> 衍生出来，就像这样：<code>t.prototype.chain = function(f) { return this.map(f).join(); }</code>。如果手动定义 <code>chain</code> 能让你觉得性能会好点的话（实际上并不会），我们也可以手动定义它，尽管还必须要费力保证函数功能的正确性——也就是说，它必须与紧接着后面有 <code>join</code> 的 <code>map</code> 相等。如果 <code>chain</code> 是简单地通过结束调用 <code>of</code> 后把值放回容器这种方式定义的，那么就会造成一个有趣的后果，即可以从 <code>chain</code> 那里衍生出一个 <code>map</code>。同样地，我们还可以用 <code>chain(id)</code> 定义 <code>join</code>。听起来好像是在跟魔术师玩德州扑克，魔术师想要什么牌就有什么牌；但是就像大部分的数学理论一样，所有这些原则性的结构都是相互关联的。<a href="https://github.com/fantasyland/fantasy-land" target="_blank" rel="noopener noreferrer">fantasyland<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 仓库中提到了许多上述衍生概念，这个仓库也是 JavaScript 官方的代数数据结构（algebraic data types）标准。</p> <p>好了，我们来看上面的例子。第一个例子中，可以看到两个 <code>Task</code> 通过 <code>chain</code> 连接形成了一个异步操作的序列——它先获取 <code>user</code>，然后用 <code>user.id</code> 查找 <code>user</code> 的 <code>friends</code>。<code>chain</code> 避免了 <code>Task(Task([Friend]))</code> 这种情况。</p> <p>第二个例子是用 <code>querySelector</code> 查找几个 input 然后创建一条欢迎信息。注意看我们是如何在最内层的函数里访问 <code>uname</code> 和 <code>email</code> 的——这是函数式变量赋值的绝佳表现。因为 <code>IO</code> 大方地把它的值借给了我们，我们也要负起以同样方式把值放回去的责任——不能辜负它的信任（还有整个程序的信任）。<code>IO.of</code> 非常适合做这件事，同时它也解释了为何 pointed 这一特性是 monad 接口得以存在的重要前提。不过，<code>map</code> 也能返回正确的类型：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;input.username&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chain</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">uname</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;input.email&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">email</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&quot;Welcome &quot;</span> <span class="token operator">+</span> uname<span class="token punctuation">.</span>value <span class="token operator">+</span> <span class="token string">&quot; prepare for spam at &quot;</span> <span class="token operator">+</span> email<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// IO(&quot;Welcome Olivia prepare for spam at olivia@tremorcontrol.net&quot;);</span>
</code></pre></div><p>最后两个例子用了 <code>Maybe</code>。因为 <code>chain</code> 其实是在底层调用了 <code>map</code>，所以如果遇到 <code>null</code>，代码就会立刻停止运行。</p> <p>如果觉得这些例子不太容易理解，你也不必担心。多跑跑代码，多琢磨琢磨，把代码拆开来研究研究，再把它们拼起来看看。总之记住，返回的如果是“普通”值就用 <code>map</code>，如果是 <code>functor</code> 就用 <code>chain</code>。</p> <p>这里我得提醒一下，上述方式对两个不同类型的嵌套容器是不适用的。functor 组合，以及后面会讲到的 monad transformer 可以帮助我们应对这种情况。</p> <h2 id="炫耀"><a href="#炫耀" class="header-anchor">#</a> 炫耀</h2> <p>这种容器编程风格有时也能造成困惑，我们不得不努力理解一个值到底嵌套了几层容器，或者需要用 <code>map</code> 还是 <code>chain</code>（很快我们就会认识更多的容器类型）。使用一些技巧，比如重写 <code>inspect</code> 方法之类，能够大幅提高 debug 的效率。后面我们也会学习如何创建一个“栈”，使之能够处理任何丢给它的作用（effects）。不过，有时候也需要权衡一下是否值得这样做。</p> <p>我很乐意挥起 monad 之剑，向你展示这种编程风格的力量。就以读一个文件，然后就把它直接上传为例吧：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// readFile :: Filename -&gt; Either String (Future Error String)</span>
<span class="token comment">// httpPost :: String -&gt; Future Error JSON</span>

<span class="token comment">//  upload :: String -&gt; Either String (Future Error JSON)</span>
<span class="token keyword">var</span> upload <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token function">chain</span><span class="token punctuation">(</span><span class="token function">httpPost</span><span class="token punctuation">(</span><span class="token string">'/uploads'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> readFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这里，代码不止一次在不同的分支执行。从类型签名可以看出，我们预防了三个错误——<code>readFile</code> 使用 <code>Either</code> 来验证输入（或许还有确保文件名存在）；<code>readFile</code> 在读取文件的时候可能会出错，错误通过 <code>readFile</code> 的 <code>Future</code> 表示；文件上传可能会因为各种各样的原因出错，错误通过 <code>httpPost</code> 的 <code>Future</code> 表示。我们就这么随意地使用 <code>chain</code> 实现了两个嵌套的、有序的异步执行动作。</p> <p>所有这些操作都是在一个从左到右的线性流中完成的，是完完全全纯的、声明式的代码，是可以等式推导（equational reasoning）并拥有可靠特性（reliable properties）的代码。我们没有被迫使用不必要甚至令人困惑的变量名，我们的 <code>upload</code> 函数符合通用接口而不是特定的一次性接口。这些都是在一行代码中完成的啊！</p> <p>让我们来跟标准的命令式的实现对比一下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//  upload :: String -&gt; (String -&gt; a) -&gt; Void</span>
<span class="token keyword">var</span> <span class="token function-variable function">upload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">filename<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>filename<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token string">&quot;You need a filename!&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">readFile</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> contents</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
      <span class="token function">httpPost</span><span class="token punctuation">(</span>contents<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> json</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
        <span class="token function">callback</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>看看，这简直就是魔鬼的算术（译者注：此处原文是“the devil's arithmetic”，为美国 1988 年出版的历史小说，讲述一个犹太小女孩穿越到 1942 年的集中营的故事。此书亦有同名改编电影，中译名《穿梭集中营》），我们就像一颗弹珠一样在变幻莫测的迷宫中穿梭。无法想象如果这是一个典型的应用，而且一直在改变变量会怎样——我们肯定会像陷入沥青坑那样无所适从。</p> <h1 id="理论"><a href="#理论" class="header-anchor">#</a> 理论</h1> <p>我们要看的第一条定律是结合律，但可能不是你熟悉的那个结合律。</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">// 结合律</span>
  <span class="token function">compose</span><span class="token punctuation">(</span>join<span class="token punctuation">,</span> <span class="token function">map</span><span class="token punctuation">(</span>join<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token function">compose</span><span class="token punctuation">(</span>join<span class="token punctuation">,</span> join<span class="token punctuation">)</span>
</code></pre></div><p>这些定律表明了 monad 的嵌套本质，所以结合律关心的是如何让内层或外层的容器类型 <code>join</code>，然后取得同样的结果。用一张图来表示可能效果会更好：</p> <img src="/mostly-adequate-guide-chinese/assets/img/monad_associativity.5f94e4a0.png" alt="monad associativity law"> <p>从左上角往下，先用 <code>join</code> 合并 <code>M(M(M a))</code> 最外层的两个 <code>M</code>，然后往右，再调用一次 <code>join</code>，就得到了我们想要的 <code>M a</code>。或者，从左上角往右，先打开最外层的 <code>M</code>，用 <code>map(join)</code> 合并内层的两个 <code>M</code>，然后再向下调用一次 <code>join</code>，也能得到 <code>M a</code>。不管是先合并内层还是先合并外层的 <code>M</code>，最后都会得到相同的 <code>M a</code>，所以这就是结合律。值得注意的一点是 <code>map(join) != join</code>。两种方式的中间步骤可能会有不同的值，但最后一个 <code>join</code> 调用后最终结果是一样的。</p> <p>第二个定律与结合律类似：</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">// 同一律 (M a)</span>
  <span class="token function">compose</span><span class="token punctuation">(</span>join<span class="token punctuation">,</span> <span class="token keyword">of</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token function">compose</span><span class="token punctuation">(</span>join<span class="token punctuation">,</span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">of</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> id
</code></pre></div><p>这表明，对任意的 monad <code>M</code>，<code>of</code> 和 <code>join</code> 相当于 <code>id</code>。也可以使用 <code>map(of)</code> 由内而外实现相同效果。我们把这个定律叫做“三角同一律”（triangle identity），因为把它图形化之后就像一个三角形：</p> <img src="/mostly-adequate-guide-chinese/assets/img/triangle_identity.262d44d6.png" alt="monad identity law"> <p>如果从左上角开始往右，可以看到 <code>of</code> 的确把 <code>M a</code> 丢到另一个 <code>M</code> 容器里去了。然后再往下 <code>join</code>，就得到了 <code>M a</code>，跟一开始就调用 <code>id</code> 的结果一样。从右上角往左，可以看到如果我们通过 <code>map</code> 进到了 <code>M</code> 里面，然后对普通值 <code>a</code> 调用 <code>of</code>，最后得到的还是 <code>M (M a)</code>；再调用一次 <code>join</code> 将会把我们带回原点，即 <code>M a</code>。</p> <p>我要说明一点，尽管这里我写的是 <code>of</code>，实际上对任意的 monad 而言，都必须要使用明确的 <code>M.of</code>。</p> <p>我已经见过这些定律了，同一律和结合律，以前就在哪儿见过...等一下，让我想想...是的！它们是范畴遵循的定律！不过这意味着我们需要一个组合函数来给出一个完整定义。见证吧：</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">var</span> <span class="token function-variable function">mcompose</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">f<span class="token punctuation">,</span> g</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token function">chain</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">chain</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 左同一律</span>
  <span class="token function">mcompose</span><span class="token punctuation">(</span><span class="token constant">M</span><span class="token punctuation">,</span> f<span class="token punctuation">)</span> <span class="token operator">==</span> f

  <span class="token comment">// 右同一律</span>
  <span class="token function">mcompose</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token constant">M</span><span class="token punctuation">)</span> <span class="token operator">==</span> f

  <span class="token comment">// 结合律</span>
  <span class="token function">mcompose</span><span class="token punctuation">(</span><span class="token function">mcompose</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> g<span class="token punctuation">)</span><span class="token punctuation">,</span> h<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token function">mcompose</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token function">mcompose</span><span class="token punctuation">(</span>g<span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>毕竟它们是范畴学里的定律。monad 来自于一个叫 “Kleisli 范畴”的范畴，这个范畴里边所有的对象都是 monad，所有的态射都是联结函数（chained funtions）。我不是要在没有提供太多解释的情况下，拿范畴学里各式各样的概念来取笑你。我的目的是涉及足够多的表面知识，向你说明这中间的相关性，让你在关注日常实用特性之余，激发起对这些定律的兴趣。</p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>monad 让我们深入到嵌套的运算当中，使我们能够在完全避免回调金字塔（pyramid of doom）情况下，为变量赋值，运行有序的作用，执行异步任务等等。当一个值被困在几层相同类型的容器中时，monad 能够拯救它。借助 “pointed” 这个可靠的帮手，monad 能够借给我们从盒子中取出的值，而且知道我们会在结束使用后还给它。</p> <p>是的，monad 非常强大，但我们还需要一些额外的容器函数。比如，假设我们想同时运行一个列表里的 api 调用，然后再搜集返回的结果，怎么办？是可以使用 monad 实现这个任务，但必须要等每一个 api 完成后才能调用下一个。合并多个合法性验证呢？我们想要的肯定是持续验证以搜集错误列表，但是 monad 会在第一个 <code>Left</code> 登场的时候停掉整个演出。</p> <p>下一章，我们将看到 applicative functor 如何融入这个容器世界，以及为何在很多情况下它比 monad 更好用。</p> <p><a href="/mostly-adequate-guide-chinese/ch10.html">第 10 章: Applicative Functor</a></p> <h2 id="练习"><a href="#练习" class="header-anchor">#</a> 练习</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 练习 1</span>
<span class="token comment">// ==========</span>
<span class="token comment">// 给定一个 user，使用 safeProp 和 map/join 或 chain 安全地获取 sreet 的 name</span>

<span class="token keyword">var</span> safeProp <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">curry</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> o</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> Maybe<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>o<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> user <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;albert&quot;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">address</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">street</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">number</span><span class="token operator">:</span> <span class="token number">22</span><span class="token punctuation">,</span>
      <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'Walnut St'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> ex1 <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>


<span class="token comment">// 练习 2</span>
<span class="token comment">// ==========</span>
<span class="token comment">// 使用 getFile 获取文件名并删除目录，所以返回值仅仅是文件，然后以纯的方式打印文件</span>

<span class="token keyword">var</span> <span class="token function-variable function">getFile</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">IO</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">return</span> __filename<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> <span class="token function-variable function">pureLog</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">IO</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">'logged '</span> <span class="token operator">+</span> x<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> ex2 <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>



<span class="token comment">// 练习 3</span>
<span class="token comment">// ==========</span>
<span class="token comment">// 使用 getPost() 然后以 post 的 id 调用 getComments()</span>
<span class="token keyword">var</span> <span class="token function-variable function">getPost</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Task</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">rej<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">res</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> i<span class="token punctuation">,</span> <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'Love them tasks'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> <span class="token function-variable function">getComments</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Task</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">rej<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">res</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
        <span class="token punctuation">{</span><span class="token literal-property property">post_id</span><span class="token operator">:</span> i<span class="token punctuation">,</span> <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token string">&quot;This book should be illegal&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token literal-property property">post_id</span><span class="token operator">:</span> i<span class="token punctuation">,</span> <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token string">&quot;Monads are like smelly shallots&quot;</span><span class="token punctuation">}</span>
      <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">var</span> ex3 <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>


<span class="token comment">// 练习 4</span>
<span class="token comment">// ==========</span>
<span class="token comment">// 用 validateEmail、addToMailingList 和 emailBlast 实现 ex4 的类型签名</span>

<span class="token comment">//  addToMailingList :: Email -&gt; IO([Email])</span>
<span class="token keyword">var</span> addToMailingList <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">list</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">email</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">IO</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>email<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> list<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">emailBlast</span><span class="token punctuation">(</span><span class="token parameter">list</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">IO</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">'emailed: '</span> <span class="token operator">+</span> list<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> <span class="token function-variable function">validateEmail</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> x<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\S+@\S+\.\S+</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Right</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Left</span><span class="token punctuation">(</span><span class="token string">'invalid email'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//  ex4 :: Email -&gt; Either String (IO String)</span>
<span class="token keyword">var</span> ex4 <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/mostly-adequate-guide-chinese/ch8.html" class="prev">
        第 8 章: 特百惠
      </a></span> <span class="next"><a href="/mostly-adequate-guide-chinese/ch10.html">
        第 10 章：Applicative Functor
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/mostly-adequate-guide-chinese/assets/js/app.e22f068f.js" defer></script><script src="/mostly-adequate-guide-chinese/assets/js/2.35b03a7f.js" defer></script><script src="/mostly-adequate-guide-chinese/assets/js/4.47caff48.js" defer></script>
  </body>
</html>
